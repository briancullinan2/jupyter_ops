<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>
  <title>discord bot</title>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <link rel='stylesheet' type='text/css' media='screen' href='main.css'>
  <style>
    nav {
      position: fixed;
      overflow: auto;
      top: 0;
      left: 0;
      right: auto;
      bottom: 0;
      width: 200px;
    }

    header {
      background-color: #EEE;
    }

    body {
      padding-left: 200px;
    }

    @media screen and (max-width: 600px) {
      body {
        padding-left: 0;
      }

      nav {
        display: none;
      }
    }
  </style>
</head>

<body>
  <nav>
    <a href="../quake3_server_connector/index.html">quake3 server connector</a>
    <br /><br />
    undefined<a href="./index.html">index</a>
<br /><br />
<a href="./ssh_remote_wget.html">ssh remote wget</a>
<br /><br />
<a href="./dns_lookup.html">dns lookup</a>
<br /><br />
<a href="./remove_ctrl_characters.html">remove ctrl characters</a>
<br /><br />
<a href="./quake3_server_status.html">quake3 server status</a>
<br /><br />
<a href="./spectate_q3_server.html">spectate q3 server</a>
<br /><br />

  </nav>
  <header>
    <a href="../quake3_server_connector/index.html">quake3 server connector</a> ${PREV} ${NEXT}
  </header>

  <p>Here is a two-sentence summary of the code breakdown:</p>
<p>The code is a Discord bot written in JavaScript using the Discord.js library, which imports various modules for interacting with the Discord API and performing specific bot functions. The bot defines regular expressions, arrays, and a configuration function that extracts command content and attachments, computes a filename, and creates a new file based on the command's content and attachments.</p>


<pre class="node"><code>var ip6addr = require('ip6addr')
var importer = require('../Core')
var challengeCommand = importer.import('challenge discord command')
var discordApi = importer.import('discord api')
var {
    getInfo, sendRcon, nextInfoResponse,
    nextPrintResponse
} = importer.import('quake 3 server commands')
var formatQuake3Response = importer.import('format quake 3 response')
var removeCtrlChars = importer.import('remove ctrl characters')

var personality = [
    'Yeehaw!',
    'Balls to wall!',
    'Do it to it!',
    'Got it!',
    'Let\'s play!',
    'Roger that!',
    'I read you!',
    'Buenos Dias!'
]

var lose = [
    'Error. Error.',
    'Oops.',
    'Boo hoo!',
    'Phooey!',
    'Au revoir, mon amis.',
    '#*&amp;^@#!!',
]

var discordCommands = {
    CHALLENGE: /^[!\\\/]?(&lt;@[^:@\s]+&gt;\s*chall?[ae]nge|chall?[ae]nge\s*&lt;@[^:@\s]+&gt;)\s*([^:@\s]*?)\s*([^:@\s]*?)/ig,
    CONNECT: /^[!\\\/]?(rcon)?conn?ect\s*([0-9\.a-z-_]+(:[0-9]+)*)$/ig,
    RCON: /^[!\\\/]?rcon(pass?wo?rd)?\s+([^"\s]+)\s*(.*)$/ig,
    DISCONNECT: /[!\\\/]?disconn?ect/ig,
    CONFIG: /^[!\\\/]?(\w*)(\.cfg|config|configure)/ig,
    LOAD: /^[!\\\/]?(load|map)\s*(\w*)/ig,
    COMMAND: /^[!\\\/]/ig,
    HELLO: /^[!\\\/](\w\s*){0,2}hello(\w\s*){0,2}/ig,
    UNKNOWN: /.*/ig,
}

async function configCommand(command) {
    if(!command.attachments &amp;&amp; !command.embed) return
    var user = command.author.username
    var options = discordCommands.CONFIG.exec(command.content)
    var options2 = command.attachments
        .map(a =&gt; discordCommands.CONFIG.exec(a.filename))
        .filter(a =&gt; a)[0]
    var name = options ? options[1] : options2 ? options2[1] : ''
        .replace(options[2], '')
        .replace(options2[2], '')
        .replace(new RegExp(user, 'ig'), '')
        .replace(/[^0-9-_a-z]/ig, '-')
    if(name.length === 0) {
        await discordApi.createMessage(`Couldn't compute filename.` + '\n```BOT'+command.id+'\nbeep boop\n```\n', command.channel_id)
        return
    }
    var file = 'player-' + user + '-' + name + '.cfg'
    await discordApi.triggerTyping(command.channel_id)
    // TODO: remote post
    //await remoteGet(command.attachments[0].url, file, '/home/freonjs/baseq3-cc/conf/')
    await discordApi.createMessage(`exec conf/player-${user}-${name}` + '\n```BOT'+command.id+'\nbeep boop\n```\n', command.channel_id)
}

var userLogins = {}
// username: {address, password, lastUsed, }
async function connectCommand(command) {
    // TODO: record last address and password given
    var user = command.author.username
    var options = discordCommands.CONNECT.exec(command.content)
    if(typeof userLogins[user] == 'undefined')
        userLogins[user] = {}
    userLogins[user] = {
        address: options[2] || userLogins[user].address || 'quakeIIIarena.com',
        password: userLogins[user].password || 'password123!'
    }
    // TODO: try to connect to server and respond with a getinfo print out
    await discordApi.triggerTyping(command.channel_id)
    var match = (/^(.*?):*([0-9]+)*$/ig).exec(userLogins[user].address)
    await getInfo(match[1], parseInt(match[2]) || 27960)
    var info = await nextInfoResponse()
    var filteredKeys = Object.keys(info)
        .filter(k =&gt; k != 'challenge'
                &amp;&amp; k != 'hostname'
                &amp;&amp; k != 'sv_hostname'
                &amp;&amp; k != 'mapname'
                &amp;&amp; k != 'clients'
                &amp;&amp; k != 'g_humanplayers'
                &amp;&amp; k != 'sv_maxclients'
                &amp;&amp; k != 'ip'
                &amp;&amp; k != 'port')
        .map(k =&gt; removeCtrlChars(k))
    var filteredValues = filteredKeys
        .map(k =&gt; removeCtrlChars(info[k]))
    var json = {
        content: '\n```BOT'+command.id+'\nbeep boop\n```\n',
        embeds: [{
            title: removeCtrlChars(info.sv_hostname || info.hostname || info.gamename || info.game || ''),
            description: info.ip + ':' + info.port,
            color: 0xdda60f,
            fields: [
                {
                    name: 'Map',
                    value: info.mapname,
                    inline: false
                },
                {
                    name: 'Players',
                    value: info.clients + ' (' + (info.g_humanplayers || '?') + ' humans)' + '/' + info.sv_maxclients,
                    inline: false
                },
                {
                    name: 'Key',
                    value: '```http\n' + filteredKeys.join('\n') + '```',
                    inline: true
                },
                {
                    name: 'Value',
                    value: '```yaml\n' + filteredValues.join('\n') + '```',
                    inline: true
                }
            ]
        }]
    }
    
    if(command.interaction)
        await discordApi.updateInteraction(json, command.id, command.token)    
    else
        await discordApi.createMessage(json, command.channel_id)    
}

async function rconCommand(command) {
    var user = command.author.username
    var options = discordCommands.RCON.exec(command.content)
    if(typeof userLogins[user] == 'undefined')
        userLogins[user] = {}
    userLogins[user] = {
        address: userLogins[user].address || 'quakeIIIarena.com',
        password: options[2] || userLogins[user].password || 'password123!'
    }
    await discordApi.triggerTyping(command.channel_id)
    var match = (/^(.*?):*([0-9]+)*$/ig).exec(userLogins[user].address)
    await sendRcon(match[1], parseInt(match[2]) || 27960,
             options[3] &amp;&amp; options[3].length &gt; 0
                 ? options[3]
                 : 'cmdlist',
             userLogins[user].password)
    var response = await nextPrintResponse()
    response = formatQuake3Response(response.content, command, response)
    if(typeof response == 'string')
        response += '\n```BOT'+command.id+'\nbeep boop\n```\n'
    else if(typeof response == 'object')
        response.content = '\n```BOT'+command.id+'\nbeep boop\n```\n'
    if(command.interaction)
        await discordApi.updateInteraction(response, command.id, command.token)    
    else
        await discordApi.createMessage(response, command.channel_id)    
}

async function chatCommand(command) {
    if(command.interaction)
        await discordApi.updateInteraction(`Hello.` + '\n```BOT'+command.id+'\nbeep boop\n```\n', command.id, command.token)
    else
        await discordApi.createMessage(`Hello.` + '\n```BOT'+command.id+'\nbeep boop\n```\n', command.channel_id)
    return
}

module.exports = {
    discordCommands,
    challengeCommand,
    configCommand,
    connectCommand,
    rconCommand,
    chatCommand,
}
</code></pre>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.css">


<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<!-- and it's easy to individually load additional languages -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/node.min.js"></script>

<script>hljs.highlightAll();</script>

<p><strong>Code Breakdown</strong></p>
<p>The code is written in JavaScript and appears to be a Discord bot using the Discord.js library. It consists of the following sections:</p>
<h3>Importing Modules</h3>
<p>The code imports various modules using the <code>require</code> function:</p>
<ul>
<li><code>ip6addr</code>: a module for working with IPv6 addresses</li>
<li><code>importer</code>: a module that imports other modules</li>
<li>Various discord-related modules:
<ul>
<li><code>discordApi</code>: a module for interacting with the Discord API</li>
<li><code>challengeCommand</code>, <code>getInfo</code>, <code>sendRcon</code>, <code>nextInfoResponse</code>, <code>nextPrintResponse</code>, <code>formatQuake3Response</code>, and <code>removeCtrlChars</code>: modules that provide specific functionality for the bot</li>
</ul></li>
</ul>
<h3>Regular Expressions</h3>
<p>The code defines several regular expressions for matching Discord commands:</p>
<ul>
<li><code>discordCommands</code>: an object containing regular expressions for each command (e.g. <code>CHALLENGE</code>, <code>CONNECT</code>, <code>RCON</code>, etc.)</li>
</ul>
<h3>Arrays</h3>
<p>The code defines two arrays:</p>
<ul>
<li><code>personality</code>: an array of phrases that the bot can respond with</li>
<li><code>lose</code>: an array of phrases that the bot can respond with when it's unable to perform an action</li>
</ul>
<h3>Function</h3>
<p>The code defines a single function:</p>
<ul>
<li><code>configCommand(command)</code>: an asynchronous function that takes a Discord command as input and performs the following actions:
<ol>
<li>Checks if the command has any attachments or an embed</li>
<li>Extracts the command's content and attachments using regular expressions</li>
<li>Computes a filename based on the command's content and attachments</li>
<li>Creates a new file with the computed filename and returns it</li>
</ol></li>
</ul>
<p>The function uses several variables and functions imported from other modules, including <code>discordApi</code>, <code>getInfo</code>, and <code>nextInfoResponse</code>.</p>

</body>

</html>