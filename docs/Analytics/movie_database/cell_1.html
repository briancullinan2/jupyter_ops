

<pre><code>var importer = require('../Core');
var levSort = importer.import('sort by levenshtein distance');
var sqlite3 = require('better-sqlite3');
var movies = './movies.sqlite.db';
var db = new sqlite3(movies, {});

function getTitles(t) {
    t = typeof t === 'string' ? [t] : t;
    return db.prepare(`
SELECT *
FROM principals
WHERE tconst IN (${t.map(i => '?').join(',')})`).all(t);
}

function getTitlesByName(n) {
    n = typeof n === 'string' ? [n] : n;
    return db.prepare(`
SELECT *
FROM principals
WHERE nconst IN (${n.map(i => '?').join(',')})`).all(n);
}

function getActorsByTitles(t, n) {
    t = typeof t === 'string' ? [t] : t;
    n = typeof n === 'string' ? [n] : n;
    return db.prepare(`
SELECT *
FROM principals
WHERE nconst IN (${n.map(i => '?').join(',')})
AND tconst IN (${t.map(i => '?').join(',')})`).all(n.concat(t));
}

var assignPromise = r => resolve => getExactName(r.nconst)
    .then(result => Object.assign(r, result))
    .then(resolve)

function getActorTitlesIntersection(n, t) {
    var titles, actors;
    return Promise.resolve()
        .then(() => getTitlesByName(n))
        .then(ts => titles = ts.map(t => t.tconst))
        .then(() => getTitles(t))
        .then(as => getActorsByTitles(titles, as.map(a => a.nconst)))
        .then(r => importer.runAllPromises(r.map(r => assignPromise(r))))
}

function getTitleTitleIntersection(t) {
    var titles = Array.from(arguments);
    return Promise.resolve()
        .then(() => getTitles(t))
        .then(as => getActorsByTitles(titles.slice(1), as.map(a => a.nconst)))
        .then(r => importer.runAllPromises(r.map(r => assignPromise(r))))
}

function getExactName(n) {
    return Promise.resolve()
        .then(() => db.prepare(`SELECT * FROM name WHERE nconst=?`).get(n))
}

function getExactTitle(t) {
    return Promise.resolve()
        .then(() => db.prepare(`SELECT * FROM titles WHERE tconst=?`).get(t))
}

function getTitle(t) {
    var words = t.split(/\s+/ig);
    return Promise.resolve()
        .then(() => db.prepare(`
SELECT * 
FROM titles 
WHERE (${words.map(word => 'primaryTitle LIKE ?').join(' AND ')})
OR (${words.map(word => 'originalTitle LIKE ?').join(' AND ')})
`).all(words.map(w => `%${w}%`).concat(words.map(w => `%${w}%`))))
        .then(results => levSort(results, t, r => r.primaryTitle)[0])
}

// https://v2.sg.media-imdb.com/suggests/w/werner%20herzog.json
$$.async();
//getTitle('three colors: white')
getTitleTitleIntersection('tt0111507', 'tt0111495', 'tt0108394')
//getActorTitlesIntersection('nm0001348', 'tt0082694')
    .then(r => $$.sendResult(r))
    .catch(e => $$.sendError(e))
    // close the database connection
    .then(() => db.close())
</code></pre>

