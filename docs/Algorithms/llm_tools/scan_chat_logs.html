<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>
  <title>scan chat logs</title>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <link rel='stylesheet' type='text/css' media='screen' href='main.css'>
  <style>
    nav {
      position: fixed;
      overflow: auto;
      top: 0;
      left: 0;
      right: auto;
      bottom: 0;
      width: 200px;
    }

    header {
      background-color: #EEE;
    }

    body {
      padding-left: 200px;
    }

    @media screen and (max-width: 600px) {
      body {
        padding-left: 0;
      }

      nav {
        display: none;
      }
    }
  </style>
</head>

<body>
  <nav>
    <a href="../llm_tools/index.html">llm tools</a>
    <br /><br />
    <a href="./scan_chat_logs.html">scan chat logs</a>
<br /><br />
<a href="./ask_llm_about_emotions.html">ask llm about emotions</a>
<br /><br />
<a href="./cache_chat_logs.html">cache chat logs</a>
<br /><br />
<a href="./ask_llm_about_chat_conversations.html">ask llm about chat conversations</a>
<br /><br />
<a href="./llm_respond_like_a_personality.html">llm respond like a personality</a>
<br /><br />

  </nav>
  <header>
    <a href="../llm_tools/index.html">llm tools</a> ${PREV} ${NEXT}
  </header>

  <p>Here is a summary of the code in two sentences:</p>
<p>The code imports necessary modules and functions, defines constants for file system paths and regular expression patterns, and defines a function <code>cellNeedsTidying</code> to check if a cell in a chat log needs tidying. The <code>cellNeedsTidying</code> function checks five conditions, including the existence of certain properties like <code>emotions</code>, <code>date</code>, and <code>dat</code>, to determine if the cell needs tidying.</p>


<pre class="javascript"><code>
//import {fileURLToPath} from "url";
const fs = require('fs')
const path = require('path')
const {askLlamaAboutEmotions} = importer.import('ask llm about emotions')
const {storeChatHistory} = importer.import('how to cache chat logs')
//const { chatCache } = importer.import('cache chat history with llm descriptions')
const { askLlamaAboutConversation, askLlamaAboutCategory } = importer.import('ask llm about chat conversations')

const hashCode = s =&gt; s.split('').reduce((a,b) =&gt; (((a &lt;&lt; 5) - a) + b.charCodeAt(0))|0, 0)

const CHAT_DIRECTORIES = [
  '/Volumes/External/Personal/Collections/conversations',
  '/Volumes/External/Personal/Collections/conversations/Trillian/logs/AIM/Query',
  '/Volumes/External/Personal/Collections/conversations/Trillian/logs/MSN/Query',
  '/Volumes/External/Personal/Collections/conversations/Trillian/logs/old logs/AIM',
  '/Volumes/External/Personal/Collections/conversations/Trillian/logs/old logs/MSN',
  '/Volumes/External/Personal/Collections/conversations/Trillian/logs/older logs/AIM',
  '/Volumes/External/Personal/Collections/conversations/Trillian/logs/older logs/MSN',
]

const CHAT_DATES = [
  /(January|February|March|April|May|June|July|August|September|October|November|December) (\d{1,2}), \d{4}/gi,
  /(0[1-9]|[12]\d|3[01])\.(0[1-9]|1[0-2])\.\d{4}/gi,
  /(0[1-9]|1[0-2])\/(0[1-9]|[12]\d|3[01])\/\d{4}/gi,
  /\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01])/gi,
  /(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) (\d{1,2}), \d{4}/gi
]

const CHAT_TIMES = [
  /(0[1-9]|1[0-2]):([0-5]\d):([0-5]\d)\s?(AM|PM)/gi,
  /([01]\d|2[0-3]):([0-5]\d):([0-5]\d)/gi,
  /(0[1-9]|1[0-2]):([0-5]\d)\s?(AM|PM)/gi,
  /([01]\d|2[0-3]):([0-5]\d)/gi
]

const CHAT_PATH = path.join(__dirname, '..', 'Resources', 'Projects', 'conversations')

function cellNeedsTidying(cellId, chatCache) {
  return typeof chatCache[cellId] == 'undefined'
  || typeof chatCache[cellId].emotions == 'undefined'
  || typeof chatCache[cellId].category != 'string'
  || typeof chatCache[cellId].date == 'undefined'
  || !chatCache[cellId].date
  || chatCache[cellId].summary.match(/Find the derivative/gi)
  || chatCache[cellId].category == '&lt;h1&gt;'
  || typeof chatCache[cellId].from == 'undefined' || typeof chatCache[cellId].to == 'undefined'
}

function convertMessagesToNoDates(currentMessages) {
  let messageNoTimes = currentMessages
  if(typeof currentMessages != 'string') {
    messageNoTimes = messageNoTimes.join('\n').trim()
  }
  for(let i = 0; i &lt; CHAT_DATES.length; i++) {
    messageNoTimes = messageNoTimes.replace(CHAT_DATES[i], '')
  }
  for(let i = 0; i &lt; CHAT_TIMES.length; i++) {
    messageNoTimes = messageNoTimes.replace(CHAT_TIMES[i], '')
  }
  messageNoTimes = messageNoTimes.replace(/\[\s*\]\s*/gi, '')
  return messageNoTimes.split('\n')
}

async function askLlamaAboutChatLog(chatLog) {

  if(!chatLog) {
    chatLog = 'fuji897@hotmail.com'
  }

  let chatHistory = []
  let chatPath
  for(let i = 0; i &lt; CHAT_DIRECTORIES.length; i++) {
    chatPath = path.join(CHAT_DIRECTORIES[i], chatLog + '.log')
    if(fs.existsSync(chatPath)) {
      chatHistory = fs.readFileSync(chatPath).toLocaleString('utf-8').split('\n')
      break
    } else {
      chatPath = void 0
    }
  }
  if(!chatPath) return

  let chatCacheFile = path.join(CHAT_PATH, path.basename(chatPath).replace('.log', '') + '.json')
  let chatCache = {}
  if(fs.existsSync(chatCacheFile))
    chatCache = JSON.parse(fs.readFileSync(chatCacheFile).toString('utf-8'))

  let from = 0
  let mtime = fs.statSync(chatPath).mtime.getTime()
  let previousTime = mtime
  let cellCounter = 0
  let currentMessages = []
  let currentTotal = 0
  let cellId = chatPath + '[' + cellCounter + ']'
  for(let i = 0; i &lt; chatHistory.length; i++) {
    if(currentMessages.length &gt; 0 &amp;&amp; currentTotal + chatHistory[i].length &gt; 2048 || currentMessages.length == 20) {
      // process now
      // TODO: store result
      let messageBlock = currentMessages.join('\n')
      let messageNoTimes = convertMessagesToNoDates(currentMessages)
      let date = CHAT_DATES.map(d =&gt; (messageBlock.match(d) || [])[0]).filter(d=&gt;d)[0]
      let time = CHAT_TIMES.map(d =&gt; (messageBlock.match(d) || [])[0]).filter(d=&gt;d)[0]
      let now = new Date(date + ' ' + time).getTime() || previousTime
      if(date &amp;&amp; time)
        previousTime = now
      let hash = hashCode(messageBlock)
      if(cellNeedsTidying(cellId, chatCache) || chatCache[cellId].hash != hash) {
        let summary = await askLlamaAboutConversation(messageNoTimes)
        let emotions = await askLlamaAboutEmotions(messageNoTimes)
        let category = await askLlamaAboutCategory(messageNoTimes)
        storeChatHistory(cellId, mtime, summary, emotions, category, hash, now, from, i - 1)
      }
      currentMessages = []
      currentTotal = 0
      from = i
      cellCounter++
      cellId = chatPath + '[' + cellCounter + ']'
    }

    if(chatHistory[i].trim().length == 0) continue

    currentMessages[currentMessages.length] = chatHistory[i]
    currentTotal += chatHistory[i].length
  }
  if(currentMessages.length &gt; 0) {
    // process now
    let messageBlock = currentMessages.join('\n')
    let messageNoTimes = convertMessagesToNoDates(currentMessages)
    let date = CHAT_DATES.map(d =&gt; (messageBlock.match(d) || [])[0]).filter(d=&gt;d)[0]
    let time = CHAT_TIMES.map(d =&gt; (messageBlock.match(d) || [])[0]).filter(d=&gt;d)[0]
    let now = new Date(date + ' ' + time).getTime()
    let hash = hashCode(messageBlock)
    if(cellNeedsTidying(cellId, chatCache) || chatCache[cellId].hash != hash) {
      let summary = await askLlamaAboutConversation(messageNoTimes)
      let emotions = await askLlamaAboutEmotions(messageNoTimes)
      let category = await askLlamaAboutCategory(messageNoTimes)
      storeChatHistory(cellId, mtime, summary, emotions, category, hash, now, from, chatHistory.length - 1)
    }
    // TODO: store result
  }

  
}

module.exports = {
  askLlamaAboutChatLog,
  askLlamaAboutConversation,
  convertMessagesToNoDates,
  CHAT_DIRECTORIES
}
</code></pre>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.css">


<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<!-- and it's easy to individually load additional languages -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>

<script>hljs.highlightAll();</script>

<p><strong>Breakdown of the Code</strong></p>
<h3>Importing Modules and Functions</h3>
<ul>
<li>The code begins by importing necessary modules and functions:
<ul>
<li><code>fs</code> and <code>path</code> from the Node.js standard library for file system operations.</li>
<li>Functions from the <code>importer</code> module:
<ul>
<li><code>askLlamaAboutEmotions</code></li>
<li><code>storeChatHistory</code></li>
<li><code>askLlamaAboutConversation</code></li>
<li><code>askLlamaAboutCategory</code></li>
</ul></li>
</ul></li>
<li>The <code>hashCode</code> function is defined to generate a hash code from a string.</li>
</ul>
<h3>Defining Constants</h3>
<ul>
<li><code>CHAT_DIRECTORIES</code>: an array of file system paths to directories containing chat logs.</li>
<li><code>CHAT_DATES</code>: an array of regular expression patterns to match dates in different formats.</li>
<li><code>CHAT_TIMES</code>: an array of regular expression patterns to match times in different formats.</li>
<li><code>CHAT_PATH</code>: a file system path to the root directory of the conversations project.</li>
</ul>
<h3>Defining the <code>cellNeedsTidying</code> Function</h3>
<ul>
<li>This function takes two arguments: <code>cellId</code> and <code>chatCache</code>.</li>
<li>It returns a boolean value indicating whether the cell with the given <code>cellId</code> needs tidying in the <code>chatCache</code> object.</li>
<li>The function checks the following conditions:
<ul>
<li>The cell is not present in the <code>chatCache</code> object or its value is <code>undefined</code>.</li>
<li>The cell's <code>emotions</code> property is <code>undefined</code>.</li>
<li>The cell's <code>category</code> property is not a string.</li>
<li>The cell's <code>date</code> property is <code>undefined</code>.</li>
<li>The cell's <code>dat</code> property is <code>undefined</code> (note: this condition is not documented, but it appears to be checking the existence of a <code>dat</code> property).</li>
</ul></li>
</ul>

</body>

</html>