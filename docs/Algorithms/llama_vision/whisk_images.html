<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>
  <title>whisk images</title>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <link rel='stylesheet' type='text/css' media='screen' href='main.css'>
  <style>
    nav {
      position: fixed;
      overflow: auto;
      top: 0;
      left: 0;
      right: auto;
      bottom: 0;
      width: 200px;
    }

    header {
      background-color: #EEE;
    }

    body {
      padding-left: 200px;
    }

    @media screen and (max-width: 600px) {
      body {
        padding-left: 0;
      }

      nav {
        display: none;
      }
    }
  </style>
</head>

<body>
  <nav>
    <a href="../llama_vision/index.html">llama vision</a>
    <br /><br />
    <a href="./llama_vision.html">llama vision</a>
<br /><br />
<a href="./analyze_image_with_llm.html">analyze image with llm</a>
<br /><br />
<a href="./llm_deceive.html">llm deceive</a>
<br /><br />
<a href="./cell_3.html">Cell 3</a>
<br /><br />
<a href="./cell_4.html">Cell 4</a>
<br /><br />
<a href="./llm_voice.html">llm voice</a>
<br /><br />
<a href="./ollama_vision_request.html">ollama vision request</a>
<br /><br />
<a href="./start_a_bunch_of_llm_rpc_services.html">start a bunch of llm rpc services</a>
<br /><br />
<a href="./stable_diffusion_request.html">stable diffusion request</a>
<br /><br />
<a href="./mask_image.html">mask image</a>
<br /><br />
<a href="./inpaint_mask.html">inpaint mask</a>
<br /><br />
<a href="./image_2_image.html">image 2 image</a>
<br /><br />
<a href="./whisk_images.html">whisk images</a>
<br /><br />

  </nav>
  <header>
    <a href="../llama_vision/index.html">llama vision</a> ${PREV} ${NEXT}
  </header>

  <p>Here is a summary of the <code>whiskImages</code> function in two sentences:</p>
<p>The <code>whiskImages</code> function is an asynchronous function that takes four parameters (<code>subject</code>, <code>scene</code>, <code>style</code>, and <code>short</code>) and processes them to return an object with the processed parameters. It handles base64-encoded images, URLs, and file paths, and uses various modules such as <code>gaxios</code> and <code>fs</code> to make HTTP requests and interact with files.</p>


<pre class="javascript"><code>const fs = require('fs')
const { request } = require('gaxios')
const requestOllamaVision = importer.import('request ollama vision')
const selectModel = importer.import('select llm')
const {doStableRequest} = importer.import('stable diffusion request')
const {doImage2Image} = importer.import('image 2 image')
const {doBackgroundMask} = importer.import('mask image')
const {doInpaintMask} = importer.import('inpaint mask')
// TODO: use the above functions in combination to whisk together a set of images

async function whiskImages(subject, scene, style, short) {
  let promptModel = await selectModel(process.env.DEFAULT_MODEL || 'Default')

  let subjectString
  let subjectShort
  let base64_subject
  if(typeof subject == 'string') {
    if(subject.startsWith('data:image/')) {
      subject = subject.replace(/^data:image\/.*?;base64,/gi, '')
      base64_subject = Buffer.from(subject, 'base64').toString('base64')
    } else if(subject.includes('://')) {
      let result = await request({
        url: subject,
        method: 'GET',
      })
      base64_subject = Buffer.from(await result.data.arrayBuffer()).toString('base64')
    } else if (!fs.existsSync(subject)) {
      subjectString = subject
    } else {
      base64_subject = fs.readFileSync(subject).toString('base64')
    }  
  } else if(subject) {
    base64_subject = subject.toString('base64')
  }


  let sceneString
  let sceneShort
  let base64_scene
  if(typeof scene == 'string') {
    if(scene.startsWith('data:image/')) {
      scene = scene.replace(/^data:image\/.*?;base64,/gi, '')
      base64_scene = Buffer.from(scene, 'base64').toString('base64')
    } else if(scene.includes('://')) {
      let result = await request({
        url: scene,
        method: 'GET',
      })
      base64_scene = Buffer.from(await result.data.arrayBuffer()).toString('base64')
    } else if (!fs.existsSync(scene)) {
      sceneString = scene
    } else {
      base64_scene = fs.readFileSync(scene).toString('base64')
    }  
  } else if (scene) {
    base64_scene = scene.toString('base64')
  }


  let styleString
  let styleShort
  let base64_style
  if(typeof style == 'string') {
    if(style.startsWith('data:image/')) {
      style = style.replace(/^data:image\/.*?;base64,/gi, '')
      base64_style = Buffer.from(style, 'base64').toString('base64')
    } else if(style.includes('://')) {
      let result = await request({
        url: style,
        method: 'GET',
      })
      base64_style = Buffer.from(await result.data.arrayBuffer()).toString('base64')
    } else if (!fs.existsSync(style)) {
      styleString = style
    } else {
      base64_style = fs.readFileSync(style).toString('base64')
    }  
  } else if(style) {
    base64_style = style.toString('base64')
  }

  // TODO: if passing in an image, ask ollama vision for a description, 
  //   if passing in a description use it to generate the next image
  if(!subjectString &amp;&amp; base64_subject) {
    subjectString = await requestOllamaVision('data:image/png;base64,' + base64_subject, 'Describe the foreground subject of the image in one short sentence.')
  }
  if(short &amp;&amp; subjectString) {
    subjectShort = await promptModel('Summarize this sentence into four or five words:\n' + subjectString + '\nOnly return the summary, no title or explanation.')
  }

  if(!sceneString &amp;&amp; base64_scene) {
    sceneString = await requestOllamaVision('data:image/png;base64,' + base64_scene, 'Describe the scenery in the image in one short sentence.')
  }
  if(short &amp;&amp; sceneString) {
    sceneShort = await promptModel('Summarize this sentence into four or five words:\n' + sceneString + '\nOnly return the summary, no title or explanation.')
  }

  if(!styleString &amp;&amp; base64_style) {
    styleString = await requestOllamaVision('data:image/png;base64,' + base64_style, 'Describe the art style of image in one short sentence.')
  }
  if(short &amp;&amp; styleString) {
    styleShort = await promptModel('Summarize this sentence into four or five words:\n' + styleString + '\nOnly return the summary, no title or explanation.')
  }

  // TODO: if no scene, only subject and style, then just call image 2 image
  if(!base64_scene &amp;&amp; !base64_style &amp;&amp; !base64_subject) {
    // no images passed in, send directly to image generator
    if(short)
      return await doStableRequest(subjectShort + '\n' + sceneShort + '\n' + styleShort)
    else
      return await doStableRequest(subjectString + '\n' + sceneString + '\n' + styleString)
  } else if (base64_subject &amp;&amp; !sceneString) {
    // subject and style process only, pass directly to image 2 image
    if(short)
      return await doImage2Image('data:image/png;base64,' + base64_subject, subjectShort + (styleShort ? ('\n' + styleShort) : ''))
    else
      return await doImage2Image('data:image/png;base64,' + base64_subject, subjectString + (styleString ? ('\n' + styleString) : ''))
  } else if (base64_scene &amp;&amp; !subjectString) {
    // scene and style only, pass to image 2 image
    if(short)
      return await doImage2Image('data:image/png;base64,' + base64_scene, sceneShort + (styleShort ? ('\n' + styleShort) : ''))
    else
      return await doImage2Image('data:image/png;base64,' + base64_scene, sceneString + (styleString ? ('\n' + styleString) : ''))
  } else if (base64_subject &amp;&amp; sceneString) {
    // TODO: extract mask on subject
    let maskObject = await doBackgroundMask('data:image/png;base64,' + base64_subject)
    let base64_mask = maskObject.image.toString('base64')

    // TODO: combine subject with new scene
    let inpaintObject
    if(short)
      inpaintObject = await doInpaintMask(
        'data:image/png;base64,' + base64_subject, 
        'data:image/png;base64,' + base64_mask, 
        sceneShort)
    else
      inpaintObject = await doInpaintMask(
        'data:image/png;base64,' + base64_subject, 
        'data:image/png;base64,' + base64_mask, 
        sceneString)
    
    // Drop out early if there is no style specified, just do the proper inpainting
    if(!styleString) {
      return inpaintObject
    }

    let base64_inpaint = inpaintObject.image.toString('base64')
    

    // TODO: generate final image in new style
    if(short)
      return await doImage2Image('data:image/png;base64,' + base64_inpaint, styleShort + '\n' + subjectShort + '\n' + sceneShort)
    else
      return await doImage2Image('data:image/png;base64,' + base64_inpaint, styleString + '\n' + subjectString + '\n' + sceneString)
  } else {
    console.error('Missing components: ')
    return {}
  }
}

module.exports = whiskImages

</code></pre>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.css">


<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<!-- and it's easy to individually load additional languages -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>

<script>hljs.highlightAll();</script>

<p><strong>Code Breakdown</strong></p>
<p><strong>Importing Modules</strong></p>
<p>The code starts by importing various modules:</p>
<ul>
<li><code>fs</code>: The file system module for interacting with files.</li>
<li><code>gaxios</code>: A HTTP client library for making requests.</li>
<li><code>importer</code>: A custom module for importing other modules (not shown in this code snippet).</li>
<li><code>requestOllamaVision</code>, <code>selectModel</code>, <code>doStableRequest</code>, <code>doImage2Image</code>, <code>doBackgroundMask</code>, <code>doInpaintMask</code>: Various functions imported from other modules.</li>
</ul>
<p><strong>Function <code>whiskImages</code></strong></p>
<p>The <code>whiskImages</code> function takes four parameters: <code>subject</code>, <code>scene</code>, <code>style</code>, and <code>short</code>. It is an asynchronous function.</p>
<p><strong>Functionality</strong></p>
<p>The function performs the following tasks:</p>
<ol>
<li><strong>Selects a model</strong>: It selects a model using the <code>selectModel</code> function and assigns it to the <code>promptModel</code> variable.</li>
<li><strong>Processes the <code>subject</code> parameter</strong>:
<ul>
<li>If <code>subject</code> is a string, it checks if it's a base64-encoded image, a URL, or a file path. If it's a base64-encoded image, it decodes it. If it's a URL, it makes a GET request to the URL and decodes the response. If it's a file path, it reads the file and decodes it.</li>
<li>If <code>subject</code> is not a string, it converts it to a string using <code>toString('base64')</code>.</li>
</ul></li>
<li><strong>Processes the <code>scene</code> parameter</strong>:
<ul>
<li>Similar to the <code>subject</code> parameter, but with its own set of checks and processing.</li>
</ul></li>
<li><strong>Returns</strong>: The function returns an object with the processed <code>subject</code> and <code>scene</code> parameters.</li>
</ol>
<p><strong>Notes</strong></p>
<ul>
<li>The function uses <code>async/await</code> syntax to handle promises.</li>
<li>The <code>request</code> function from <code>gaxios</code> is used to make HTTP requests.</li>
<li>The <code>fs</code> module is used to interact with files.</li>
<li>The <code>importer</code> module is used to import other modules.</li>
<li>The <code>requestOllamaVision</code>, <code>selectModel</code>, <code>doStableRequest</code>, <code>doImage2Image</code>, <code>doBackgroundMask</code>, <code>doInpaintMask</code> functions are not used in this code snippet, but are likely used elsewhere in the codebase.</li>
</ul>

</body>

</html>