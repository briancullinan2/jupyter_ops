<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>
  <title>test zuora export month</title>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <link rel='stylesheet' type='text/css' media='screen' href='main.css'>
  <style>
    html {
      padding: 0;
      margin: 0;
    }

    nav {
      position: fixed;
      overflow: auto;
      top: 0;
      left: 0;
      right: auto;
      bottom: 0;
      width: 200px;
    }

    header {
      background-color: #EEE;
      padding: 10px;
    }

    body {
      padding: 0 0 0 200px;
      margin: 0;
    }

    .gold pre code,
    .gold pre code span,
    .gold code pre,
    .gold code pre span {
      color: gold;
    }

    @media screen and (max-width: 600px) {
      body {
        padding-left: 0;
      }

      nav {
        display: none;
      }
    }
  </style>
</head>

<body>
  <nav>
    <h3><a href="../zuora_to_eloqua/index.html">zuora to eloqua</a></h3>
    <a href="./zuora_export_service.html">zuora export service</a>
<br /><br />
<a href="./zuora_export_catalog.html">zuora export catalog</a>
<br /><br />
<a href="./zuora_export_service_test.html">zuora export service test</a>
<br /><br />
<a href="./zuora_renewals_query.html">zuora renewals query</a>
<br /><br />
<a href="./test_zuora_renewals_query.html">test zuora renewals query</a>
<br /><br />
<a href="./eloqua_import_service.html">eloqua import service</a>
<br /><br />
<a href="./test_eloqua_import_service.html">test eloqua import service</a>
<br /><br />
<a href="./zuora_eloqua_mapper.html">zuora eloqua mapper</a>
<br /><br />
<a href="./zuora_eloqua_mapper_test.html">zuora eloqua mapper test</a>
<br /><br />
<a href="./zuora_account_blueprints.html">zuora account blueprints</a>
<br /><br />
<a href="./eloqua_import_create_template.html">eloqua import create template</a>
<br /><br />
<a href="./test_eloqua_import_create_template.html">test eloqua import create template</a>
<br /><br />
<a href="./eloqua_import_blueprints.html">eloqua import blueprints</a>
<br /><br />
<a href="./eloqua_existing_import.html">eloqua existing import</a>
<br /><br />
<a href="./test_eloqua_existing_import.html">test eloqua existing import</a>
<br /><br />
<a href="./aws_entry_point.html">aws entry point</a>
<br /><br />
<a href="./test_aws_entry_point.html">test aws entry point</a>
<br /><br />
<a href="./notify_entry_point.html">notify entry point</a>
<br /><br />
<a href="./test_notify_entry_point.html">test notify entry point</a>
<br /><br />
<a href="./zuora_export_month.html">zuora export month</a>
<br /><br />
<a href="./test_zuora_export_month.html">test zuora export month</a>
<br /><br />
<a href="./zuora_account_service.html">zuora account service</a>
<br /><br />
<a href="./test_zuora_account_service.html">test zuora account service</a>
<br /><br />
<a href="./bulk_upload_eloqua.html">bulk upload eloqua</a>
<br /><br />
<a href="./test_bulk_upload_eloqua.html">test bulk upload eloqua</a>
<br /><br />
<a href="./sync_zuora_eloqua_end_to_end.html">sync zuora eloqua end to end</a>
<br /><br />
<a href="./calculate_price.html">calculate price</a>
<br /><br />
<a href="./calculate_price_test.html">calculate price test</a>
<br /><br />
<a href="./readme.html">readme</a>
<br /><br />
<a href="./cell_29.html">Cell 29</a>
<br /><br />
<a href="./cell_30.html">Cell 30</a>
<br /><br />
<a href="./cell_31.html">Cell 31</a>
<br /><br />
<a href="./cell_32.html">Cell 32</a>
<br /><br />

  </nav>
  <header>
    <a href="../zuora_to_eloqua/index.html">zuora to eloqua</a> | <a href="./zuora_export_month.html">zuora export month</a> | <a href="./zuora_account_service.html">zuora account service</a> | <a href="../../search.html">Search</a>
  </header>

  <p>This code unit tests the <code>exporter</code> module, which handles Zuora API interactions for data export, by mocking API responses and verifying expected behavior in retrieving queries and initiating exports.</p>
<h2>Run example</h2>

<pre language="bash"><code>npm run import -- "test zuora export month"</code></pre><h1>test zuora export month</h1>



<pre class="javascript"><code>var assert = require('assert');
var sinon = require('sinon');
var exporter = importer.import("<a href="../../Frameworks/zuora_to_eloqua/zuora_export_month.html">zuora export month</a>");
var zuoraExport = importer.import("<a href="../../Frameworks/zuora_to_eloqua/zuora_export_service.html">zuora to eloqua.ipynb[0</a>");
var renewalsQuery = importer.import("<a href="../../Frameworks/zuora_to_eloqua/zuora_renewals_query.html">zuora renewals query</a>");

var sandbox = sinon.createSandbox();
var zuoraConfig = {
    "rest_api_user":"devteam@fakepage.com",
    "rest_api_password":"pass",
    "rest_api_url": "http://localhost:18888"
};

describe('zuora export month', () =&gt; {
    
    afterEach(() =&gt; {
        sandbox.restore();
    })
    
    it('should get the query', () =&gt; {
        const dummyQuery = 'test query';
        
        sandbox.stub(zuoraExport, "createBulkExportJob").returns(Promise.resolve(''));
        sandbox.stub(zuoraExport, "getBulkExportJobStatus");
        sandbox.stub(zuoraExport, "getBulkExportFile");
        sandbox.stub(zuoraExport, "csvToJson").returns(Promise.resolve([]));
        const queryStub = sandbox.stub(renewalsQuery, "getQuery")
            .returns({ Query: dummyQuery });

        return exporter.getZuoraMonth(0, zuoraConfig).then(result =&gt; {
                assert.equal(result.length, 0);
                assert(queryStub.calledOnce, 'getQuery should only be called once');
                const stubCall = queryStub.getCall(0);
                assert.equal(new Date(stubCall.args[0]).getMonth(), (new Date()).getMonth());
        });
    })
    
    it('should call bulk export service', () =&gt; {
        const dummyQuery = 'test query';
        
        const exportStub = sandbox.stub(zuoraExport, "createBulkExportJob").returns(Promise.resolve(''));
        sandbox.stub(zuoraExport, "getBulkExportJobStatus");
        sandbox.stub(zuoraExport, "getBulkExportFile");
        sandbox.stub(zuoraExport, "csvToJson").returns(Promise.resolve([]));
        sandbox.stub(renewalsQuery, "getQuery")
            .returns({ Query: dummyQuery });

        return exporter.getZuoraMonth(0, zuoraConfig).then(result =&gt; {
                assert.equal(result.length, 0);
                assert(exportStub.calledOnce, 'createBulkExportJob should only be called once');
                const stubCall = exportStub.getCall(0);
                assert.equal(stubCall.args[0].Query, dummyQuery);
        });
    })
    
    it('should convert csv dump to json', () =&gt; {
        const dummyCsv = 'this,is,a,test\n1,2,3,4';
        
        sandbox.stub(zuoraExport, "createBulkExportJob").returns(Promise.resolve(''));
        sandbox.stub(zuoraExport, "getBulkExportJobStatus");
        sandbox.stub(zuoraExport, "getBulkExportFile").returns(Promise.resolve(dummyCsv));
        sandbox.stub(renewalsQuery, "getQuery").returns({ Query: 'test query' });
        
        return exporter.getZuoraMonth(0, zuoraConfig).then(result =&gt; {
                assert.equal(result[0].test, 4);
        });
    })
})
</code></pre>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.css">


<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<!-- and it's easy to individually load additional languages -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
<script src="../../mergehtml.js"></script>

<script>
hljs.addPlugin(mergeHTMLPlugin);
hljs.highlightAll();
</script>

<div class="gold"><h2>What the code could have been:</h2>
<pre class="javascript"><code>// Import required modules
const sinon = require('sinon');
const assert = require('assert');
const importer = require('./importer');

// Import required scripts
const zuoraExportMonth = importer.import('zuora export month');
const zuoraToEloqua = importer.import('zuora to eloqua.ipynb[0]');
const renewalsQuery = importer.import('zuora renewals query');

// Define constants
const ZUORA_CONFIG_KEY = 'zuoraConfig';

// Create a Sinon sandbox for testing
const sandbox = sinon.createSandbox();

// Define the test suite
describe('Zuora Export Month', () => {
  // Clean up the sandbox after each test
  afterEach(() => {
    sandbox.restore();
  });

  // Define a helper function to get the Zuora config
  function getConfig(key = ZUORA_CONFIG_KEY) {
    return sinon.stub(zuoraExportMonth, `getConfig`).returns({ [key]: {} });
  }

  // Define a helper function to get the Zuora month data
  function getZuoraMonth(query = 'test query', config = {}, expectedLength = 0) {
    // Stub the createBulkExportJob method
    const createBulkExportJobStub = sandbox.stub(zuoraToEloqua, 'createBulkExportJob').returns(Promise.resolve(''));
    // Stub the getBulkExportJobStatus method
    sandbox.stub(zuoraToEloqua, 'getBulkExportJobStatus');
    // Stub the getBulkExportFile method
    sandbox.stub(zuoraToEloqua, 'getBulkExportFile').returns(Promise.resolve(''));
    // Stub the csvToJson method
    sandbox.stub(zuoraToEloqua, 'csvToJson').returns(Promise.resolve([]));
    // Stub the getQuery method
    sandbox.stub(renewalsQuery, 'getQuery').returns({ Query: query });

    // Call the getZuoraMonth method
    return zuoraExportMonth.getZuoraMonth(0, config).then((result) => {
      // Assert the result
      assert.equal(result.length, expectedLength);
    });
  }

  // Define a test to get the query
  it('should get the query', () => {
    // Call the getZuoraMonth method
    return getZuoraMonth().then(() => {
      // Assert that the getQuery method was called once
      const queryStub = sandbox.stub(renewalsQuery, 'getQuery');
      assert.equal(queryStub.callCount, 1);
      const stubCall = queryStub.getCall(0);
      // Assert that the query is the current month
      assert.equal(new Date(stubCall.args[0]).getMonth(), (new Date()).getMonth());
    });
  });

  // Define a test to call the bulk export service
  it('should call bulk export service', () => {
    // Call the getZuoraMonth method
    return getZuoraMonth().then(() => {
      // Assert that the createBulkExportJob method was called once
      const createBulkExportJobStub = sandbox.stub(zuoraToEloqua, 'createBulkExportJob');
      assert.equal(createBulkExportJobStub.callCount, 1);
      const stubCall = createBulkExportJobStub.getCall(0);
      // Assert that the query is the test query
      assert.equal(stubCall.args[0].Query, 'test query');
    });
  });

  // Define a test to convert the CSV dump to JSON
  it('should convert CSV dump to JSON', () => {
    // Stub the getBulkExportFile method to return a CSV string
    const csvStub = sandbox.stub(zuoraToEloqua, 'getBulkExportFile').returns(Promise.resolve('this,is,a,test\n1,2,3,4'));
    // Call the getZuoraMonth method
    return getZuoraMonth().then((result) => {
      // Assert that the result is an array with the expected length
      assert.equal(result.length, 1);
      // Assert that the first element of the result has the expected properties
      assert.equal(result[0].test, 4);
    });
  });
});</code></pre></div><p>This code defines unit tests for a module named <code>exporter</code> that interacts with the Zuora API to export data.</p>
<p>Here's a breakdown:</p>
<ol>
<li><p><strong>Setup:</strong></p>
<ul>
<li>Imports necessary modules: <code>assert</code> for assertions, <code>sinon</code> for mocking, and modules related to Zuora API interaction (<code>exporter</code>, <code>zuoraExport</code>, <code>renewalsQuery</code>).</li>
<li>Creates a sandbox using <code>sinon.createSandbox()</code> to isolate the test environment.</li>
<li>Defines a sample <code>zuoraConfig</code> object with placeholder credentials.</li>
</ul></li>
<li><p><strong>Test Suite:</strong></p>
<ul>
<li>Uses <code>describe('zuora export month', () =&gt; { ... })</code> to define a test suite.</li>
</ul></li>
<li><p><strong>Test Cases:</strong></p>
<ul>
<li><code>afterEach(() =&gt; { sandbox.restore(); })</code>: Restores the sandbox after each test to avoid interference.</li>
<li><code>it('should get the query', () =&gt; { ... })</code>:
<ul>
<li>Mocks functions within <code>zuoraExport</code> and <code>renewalsQuery</code> to simulate API calls and data retrieval.</li>
<li>Calls <code>exporter.getZuoraMonth(0, zuoraConfig)</code> to test the function.</li>
<li>Asserts that the returned result is empty and that the <code>getQuery</code> function was called once with the correct parameters.</li>
</ul></li>
<li><code>it('should call bulk export service', () =&gt; { ... })</code>:
<ul>
<li>Similar to the previous test, but focuses on verifying that the <code>createBulkExportJob</code> function is called once with the correct query.</li>
</ul></li>
</ul></li>
<li><p><strong>Conclusion:</strong></p>
<p>These tests verify the functionality of the <code>exporter</code> module by mocking API responses and asserting the expected behavior. They cover aspects like query retrieval, API calls, and data processing.</p></li>
</ol>

</body>

</html>