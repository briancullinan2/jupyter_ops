<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>
  <title>zuora export month</title>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <link rel='stylesheet' type='text/css' media='screen' href='main.css'>
  <style>
    html {
      padding: 0;
      margin: 0;
    }

    nav {
      position: fixed;
      overflow: auto;
      top: 0;
      left: 0;
      right: auto;
      bottom: 0;
      width: 200px;
    }

    header {
      background-color: #EEE;
      padding: 10px;
    }

    body {
      padding: 0 0 0 200px;
      margin: 0;
    }

    .gold pre code,
    .gold pre code span,
    .gold code pre,
    .gold code pre span {
      color: gold;
    }

    @media screen and (max-width: 600px) {
      body {
        padding-left: 0;
      }

      nav {
        display: none;
      }
    }
  </style>
</head>

<body>
  <nav>
    <h3><a href="../zuora_to_eloqua/index.html">zuora to eloqua</a></h3>
    <a href="./zuora_export_service.html">zuora export service</a>
<br /><br />
<a href="./zuora_export_catalog.html">zuora export catalog</a>
<br /><br />
<a href="./zuora_export_service_test.html">zuora export service test</a>
<br /><br />
<a href="./zuora_renewals_query.html">zuora renewals query</a>
<br /><br />
<a href="./test_zuora_renewals_query.html">test zuora renewals query</a>
<br /><br />
<a href="./eloqua_import_service.html">eloqua import service</a>
<br /><br />
<a href="./test_eloqua_import_service.html">test eloqua import service</a>
<br /><br />
<a href="./zuora_eloqua_mapper.html">zuora eloqua mapper</a>
<br /><br />
<a href="./zuora_eloqua_mapper_test.html">zuora eloqua mapper test</a>
<br /><br />
<a href="./zuora_account_blueprints.html">zuora account blueprints</a>
<br /><br />
<a href="./eloqua_import_create_template.html">eloqua import create template</a>
<br /><br />
<a href="./test_eloqua_import_create_template.html">test eloqua import create template</a>
<br /><br />
<a href="./eloqua_import_blueprints.html">eloqua import blueprints</a>
<br /><br />
<a href="./eloqua_existing_import.html">eloqua existing import</a>
<br /><br />
<a href="./test_eloqua_existing_import.html">test eloqua existing import</a>
<br /><br />
<a href="./aws_entry_point.html">aws entry point</a>
<br /><br />
<a href="./test_aws_entry_point.html">test aws entry point</a>
<br /><br />
<a href="./notify_entry_point.html">notify entry point</a>
<br /><br />
<a href="./test_notify_entry_point.html">test notify entry point</a>
<br /><br />
<a href="./zuora_export_month.html">zuora export month</a>
<br /><br />
<a href="./test_zuora_export_month.html">test zuora export month</a>
<br /><br />
<a href="./zuora_account_service.html">zuora account service</a>
<br /><br />
<a href="./test_zuora_account_service.html">test zuora account service</a>
<br /><br />
<a href="./bulk_upload_eloqua.html">bulk upload eloqua</a>
<br /><br />
<a href="./test_bulk_upload_eloqua.html">test bulk upload eloqua</a>
<br /><br />
<a href="./sync_zuora_eloqua_end_to_end.html">sync zuora eloqua end to end</a>
<br /><br />
<a href="./calculate_price.html">calculate price</a>
<br /><br />
<a href="./calculate_price_test.html">calculate price test</a>
<br /><br />
<a href="./readme.html">readme</a>
<br /><br />
<a href="./cell_29.html">Cell 29</a>
<br /><br />
<a href="./cell_30.html">Cell 30</a>
<br /><br />
<a href="./cell_31.html">Cell 31</a>
<br /><br />
<a href="./cell_32.html">Cell 32</a>
<br /><br />

  </nav>
  <header>
    <a href="../zuora_to_eloqua/index.html">zuora to eloqua</a> | <a href="./test_notify_entry_point.html">test notify entry point</a> | <a href="./test_zuora_export_month.html">test zuora export month</a> | <a href="../../search.html">Search</a>
  </header>

  <p>This code provides a function to fetch renewal data from Zuora for a given time period and returns it in a usable JSON format.  It leverages modules for querying Zuora, exporting data, and converting CSV to JSON.</p>
<h2>Run example</h2>

<pre language="bash"><code>npm run import -- "zuora export month"</code></pre><h1>zuora export month</h1>



<pre class="javascript"><code>var importer = require('../Core');
var renewalsQuery = importer.import("<a href="../../Frameworks/zuora_to_eloqua/zuora_renewals_query.html">zuora renewals query</a>");
var zuoraExport = importer.import("<a href="../../Frameworks/zuora_to_eloqua/zuora_export_service.html">zuora to eloqua.ipynb[0</a>");

function getZuoraMonth(months, zuoraConfig) {
    if(!months) {
        months = 0;
    }
    var start = new Date();
    start.setMonth(start.getMonth() - months);
    start.setDate(1);
    start.setHours(0, 0, 0);
    var end = new Date();
    end.setMonth(end.getMonth() + months + 1);
    end.setDate(1);
    end.setHours(0, 0, 0);
    if(start.getMonth() &gt; end.getMonth()) {
        end.getFullYear(end.getFullYear() + 1)
    }
    
    return zuoraExport.createBulkExportJob(renewalsQuery.getQuery(start.toString(), end.toString()), zuoraConfig)
        .then(exportId =&gt; zuoraExport.getBulkExportJobStatus(exportId, zuoraConfig))
        .then(fileId =&gt; zuoraExport.getBulkExportFile(fileId, zuoraConfig))
        .then(r =&gt; zuoraExport.csvToJson(r))
}
module.exports = {
    getZuoraMonth
};
</code></pre>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.css">


<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<!-- and it's easy to individually load additional languages -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
<script src="../../mergehtml.js"></script>

<script>
hljs.addPlugin(mergeHTMLPlugin);
hljs.highlightAll();
</script>

<div class="gold"><h2>What the code could have been:</h2>
<pre class="javascript"><code>// Import required modules and utilities
const { importer } = require('../Core');
const { renewalsQuery } = importer.import('zuora renewals query');
const { zuoraExport } = importer.import('zuora to eloqua.ipynb')[0];

/**
 * Calculates the start and end dates for a specific number of months.
 * 
 * @param {number} [months=0] The number of months to calculate for.
 * @returns {Object} An object with start and end dates.
 */
function getMonthDateRange(months = 0) {
    const start = new Date();
    start.setMonth(start.getMonth() - months);
    start.setDate(1);
    start.setHours(0, 0, 0);
    const end = new Date();
    end.setMonth(end.getMonth() + months + 1);
    end.setDate(1);
    end.setHours(0, 0, 0);
    // Correct for February (29th doesn't exist in some years)
    if (start.getMonth() > end.getMonth()) {
        end.setFullYear(end.getFullYear() + 1);
    }
    return { start: start.toISOString(), end: end.toISOString() };
}

/**
 * Retrieves data from Zuora for a specific date range.
 * 
 * @param {Object} zuoraConfig - The Zuora API configuration.
 * @returns {Promise<string>} The ID of the bulk export job.
 */
function getZuoraExport(zuoraConfig) {
    const { start, end } = getMonthDateRange();
    const query = renewalsQuery.getQuery(start, end);
    return zuoraExport.createBulkExportJob(query, zuoraConfig);
}

/**
 * Gets the status of the bulk export job.
 * 
 * @param {string} exportId - The ID of the bulk export job.
 * @param {Object} zuoraConfig - The Zuora API configuration.
 * @returns {Promise<any>} The status of the bulk export job.
 */
function getBulkExportStatus(exportId, zuoraConfig) {
    return zuoraExport.getBulkExportJobStatus(exportId, zuoraConfig);
}

/**
 * Gets the CSV file associated with the bulk export job.
 * 
 * @param {string} fileId - The ID of the file.
 * @param {Object} zuoraConfig - The Zuora API configuration.
 * @returns {Promise<any>} The CSV file contents.
 */
function getBulkExportFile(fileId, zuoraConfig) {
    return zuoraExport.getBulkExportFile(fileId, zuoraConfig);
}

/**
 * Converts the CSV file to JSON.
 * 
 * @param {any} csvFile - The CSV file contents.
 * @returns {Promise<string>} The JSON contents of the CSV file.
 */
function csvToJson(csvFile) {
    return zuoraExport.csvToJson(csvFile);
}

/**
 * Retrieves the Zuora data for a specific number of months.
 * 
 * @param {number} [months=0] The number of months to retrieve data for.
 * @param {Object} zuoraConfig - The Zuora API configuration.
 * @returns {Promise<string>} The JSON contents of the CSV file.
 */
module.exports = {
    getZuoraMonth: async function (months = 0, zuoraConfig) {
        const exportId = await getZuoraExport(zuoraConfig);
        const status = await getBulkExportStatus(exportId, zuoraConfig);
        const fileId = await getBulkExportStatus(exportId, zuoraConfig);
        const csvFile = await getBulkExportFile(fileId, zuoraConfig);
        return csvToJson(csvFile);
    }
};</code></pre></div><p>This code defines a function <code>getZuoraMonth</code> that retrieves renewal data from Zuora for a specified period and converts it into a JSON format.</p>
<p>Here's a breakdown:</p>
<ol>
<li><p><strong>Initialization:</strong></p>
<ul>
<li>It imports modules for querying Zuora renewals, exporting data from Zuora, and handling the conversion of CSV data to JSON.</li>
</ul></li>
<li><p><strong><code>getZuoraMonth</code> Function:</strong></p>
<ul>
<li>It takes two arguments: <code>months</code> (number of months to retrieve data for) and <code>zuoraConfig</code> (configuration object for interacting with Zuora).</li>
<li>It calculates the start and end dates for the specified period.</li>
<li>It uses the <code>renewalsQuery</code> module to generate a query for retrieving renewal data within the calculated date range.</li>
<li>It uses the <code>zuoraExport</code> module to:
<ul>
<li>Create a bulk export job in Zuora.</li>
<li>Get the status of the export job.</li>
<li>Retrieve the exported file.</li>
<li>Convert the CSV data from the exported file into JSON format.</li>
</ul></li>
</ul></li>
<li><p><strong>Export:</strong></p>
<ul>
<li>The <code>getZuoraMonth</code> function is exported as the main module, making it available for use in other parts of the application.</li>
</ul></li>
</ol>

</body>

</html>