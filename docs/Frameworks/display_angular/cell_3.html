

<pre><code>// TODO: move this to web extension code?
var importer = require('../Core');
var fs = require('fs');
var https = require('https');
var app = require('express')();
var {
    searchProvider, sockify, seleniumServer
} = importer.import([
    'mock properties rewire',
    'search notebook provider',
    'socket.io server',
    'selenium http server'
]);

var httpsOptions = {
    key: fs.readFileSync('../Utilities/.ca/intermediate/private/localhost.key.pem'),
    cert: fs.readFileSync('../Utilities/.ca/intermediate/certs/localhost.cert.pem'),
    passphrase: 'x',
    //requestCert: true,
    rejectUnauthorized: false
};
var secureServer = require('https').createServer(httpsOptions, app);
var trustedCa = ['../Utilities/ca/intermediate/certs/localhost.cert.pem'];

https.globalAgent.options.ca = [];
for (const ca of trustedCa) {
    https.globalAgent.options.ca.push(httpsOptions.cert);
}

sockify = r[1];
searchProvider = r[0];
seleniumServer = r[2];

var listener = secureServer.listen(8000);
sockify.sockifyServer(listener);
sockify.sockifyRequire({
    prototype: {
        search: function () {
        },
        results: function () {
        }
    }
}, 'SearchService');
sockify.sockifyRequire({
    prototype: {
        chrome: function () {
        }
    }
}, 'BrowserService');
searchProvider();

$$.async();
seleniumServer()
    .catch(e => $$.sendError(e));

// var PROFILE_PATH = process.env.HOME || process.env.HOMEPATH || process.env.USERPROFILE;
// var keyChain = path.join(PROFILE_PATH, '/Library/Keychains/login.keychain');

// security add-trusted-cert -d -r trustAsRoot -k ../Library/Keychains/login.keychain ../server.crt

/// 
/* TODO: integrate with native messaging?

{
  "name": "com.my_company.my_application",
  "description": "My Application",
  "path": "C:\\Program Files\\My Application\\chrome_native_messaging_host.exe",
  "type": "stdio",
  "allowed_origins": [
    "chrome-extension://knldjmfmopnpolahpmmgbagdohdnhkik/"
  ]
}

*/

</code></pre>

